Errand-System — Frontend Integration Guide
==========================================

Purpose
-------
This guide explains how a WordPress frontend (or any other client) can integrate with the Errand-System backend API. It includes endpoints, authentication flows, example requests (curl and PHP), webhook notes, and environment details needed when moving to live Paystack.

Base URL
--------
Assume the backend API is available at:

    https://api.example.com/

All endpoints in this guide are relative to that base. The project mounts APIs under `/api/`.

Authentication
--------------
The backend uses JSON Web Tokens (JWT) for authentication (rest_framework_simplejwt).

1. Login (get access token)
   - POST /api/user/login/
   - Body: JSON { "username": "...", "password": "..." }
   - Response: { "message": "Login successful", "user": {...}, "tokens": {"access": "...", "refresh": "..."} }

2. Use the access token in requests that require authentication:
   - Header: Authorization: Bearer <access_token>

3. Refresh token when access expires:
   - POST /api/user/token/refresh/ { "refresh": "<refresh_token>" }

Key API Endpoints
-----------------
User
  - POST /api/user/signup/           (signup)               — public
  - POST /api/user/login/            (login)                — public
  - POST /api/user/change-password/  — requires JWT
  - POST /api/user/verify-user/      — save verification/profile data (requires JWT)
  - POST /api/user/verify-vda/       — create VDA (requires JWT)

Errands
  - GET  /api/errands/              — list errands
  - POST /api/errands/create/       — create errand (requires JWT)
  - GET  /api/errands/<id>/         — single errand
  - POST /api/errands/<id>/accept/  — accept errand (requires JWT)
  - POST /api/errands/<id>/mark_completed/ — requires JWT
  - POST /api/errands/<id>/approve_completion/ — requires JWT
  - POST /api/errands/<id>/review/ — create a review (requires JWT)

Payment
  - POST /api/payment/initialize/    — initialize payment (requires JWT)
       payload: { "errand_id": <int>, "amount": <decimal> }
       returns: authorization_url, reference
  - GET  /api/payment/verify/<reference>/  — verify payment (requires JWT)
  - POST /api/payment/webhook/       — Paystack webhook (AllowAny) — secure this in production
  - GET  /api/payment/list/          — list payments for user (requires JWT)
  - GET  /api/payment/detail/<ref>/  — get payment detail (requires JWT)

Example curl requests
---------------------
1) Login and get token

curl -X POST https://api.example.com/api/user/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"alice","password":"secret"}'

Response:
{
  "message": "Login successful",
  "user": { ... },
  "tokens": {"access": "<ACCESS>", "refresh": "<REFRESH>"}
}

2) Create an errand (server-side call)

curl -X POST https://api.example.com/api/errands/create/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <ACCESS>" \
  -d '{"title":"Buy groceries","description":"Milk & eggs","price": 10.50, "duration": 60}'

3) Initialize a payment for an errand

curl -X POST https://api.example.com/api/payment/initialize/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <ACCESS>" \
  -d '{"errand_id": 123, "amount": 10.50}'

Response contains `authorization_url` where you can redirect the user to complete payment.

4) Verify VDA (create virtual account for the user)

curl -X POST https://api.example.com/api/user/verify-vda/ \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <ACCESS>" \
  -d '{"fname": "John", "lname": "Doe", "email": "john@example.com", "phone_num": "08012345678", "account_num":"1234567890","bank_name":"AnyBank"}'

PHP (WordPress) examples
------------------------
Below are simple PHP examples using cURL you can adapt inside WordPress (server-side). For client-side interactions prefer server-to-server calls to avoid exposing secret keys.

1) Login (get JWT)

<?php
function api_post($url, $data) {
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Content-Type: application/json']);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    $res = curl_exec($ch);
    curl_close($ch);
    return json_decode($res, true);
}

$login = api_post('https://api.example.com/api/user/login/', [
    'username' => 'alice',
    'password' => 'secret'
]);
$access = $login['tokens']['access'];
?>

2) Initialize payment (using the token)

<?php
function api_post_auth($url, $data, $token) {
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, [
        'Content-Type: application/json',
        'Authorization: Bearer ' . $token
    ]);
    curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    $res = curl_exec($ch);
    curl_close($ch);
    return json_decode($res, true);
}

$init = api_post_auth('https://api.example.com/api/payment/initialize/', [
    'errand_id' => 123,
    'amount' => 10.5
], $access);
// $init['authorization_url'] contains the redirect URL for payment
?>

Webhook configuration (Paystack)
--------------------------------
- Configure the Paystack dashboard to POST webhook events to:
    https://api.example.com/api/payment/webhook/
- IMPORTANT: The webhook endpoint currently does not validate signatures — implement signature verification in production.
- Test webhook payloads using Paystack's dashboard or a request replay tool (ngrok is handy for local dev).

CORS and browser-based calls
----------------------------
- If your WordPress frontend makes client-side fetch/XHR calls to the API from the browser, you must enable CORS on the Django side (e.g., using the `django-cors-headers` package) and add the WordPress origin to allowed origins.
- Alternative: perform API calls server-side in PHP — avoids CORS and keeps secrets secure.

Environment and production notes
--------------------------------
- Use the env variable `PAYSTACK_FAKE_IN_TESTS=true` during CI/test runs to avoid real Paystack calls.
- To use live Paystack in staging/production:
  1. Set `PAYSTACK_FAKE_IN_TESTS=false` (or unset it).
  2. Provide `PAYSTACK_SECRET_KEY` and `PAYSTACK_PUBLIC_KEY` environment variables.
  3. Ensure `ALLOWED_HOSTS` and `DEBUG` are set appropriately.

Security checklist before production
-----------------------------------
- Set DEBUG=False and configure `ALLOWED_HOSTS`.
- Add HTTPS and secure headers.
- Secure the webhook endpoint by validating Paystack signatures.
- Protect secret keys using environment variables and a secrets manager.

Helpful tips
------------
- For development, prefer server-side (PHP) calls from WordPress to avoid CORS and to keep keys secret.
- Add logging on both sides (frontend + backend) to ease debugging.
- Consider adding OpenAPI/Swagger docs for the API to help frontend developers — I can add that if you want.

If you want, I can also:
- Produce a Postman collection of these endpoints.
- Add a short GitHub Actions snippet showing how to set `PAYSTACK_FAKE_IN_TESTS=true` in CI.

Contact me which of those you prefer and I'll add it.
